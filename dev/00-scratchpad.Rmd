---
title: "explore-ideas"
output: html_document
---

```{r}
library(tidyverse)


experiencesdashboard::sentiment_txt_data
experiencesdashboard::tidy_trust_data


```
```{r}
experiencesdashboard::sentiment_txt_data %>% 
  mutate(date = lubridate::as_date(date)) %>% 
  tidyr::unnest(cols = all_sentiments) %>% 
  dplyr::select(date, all_sentiments) %>% 
  tidyr::drop_na() %>% 
  # dplyr::mutate(all_sentiments = factor(x = all_sentiments,
  #                                       levels = sentiments_ordered,
  #                                       labels = sentiments_ordered_sentence)) %>%
  # dplyr::mutate(all_sentiments = dplyr::case_when(all_sentiments %in% input$select_sentiment_plot ~ all_sentiments,
  #                                                 TRUE ~ NA_character_),
  #               all_sentiments = stringr::str_to_sentence(all_sentiments)) %>% 
  ggplot2::ggplot(ggplot2::aes(date, 
                               fill = all_sentiments,
                               colour = all_sentiments)) +
  ggplot2::geom_density(alpha = .1, size = 1) +
  # ggplot2::geom_histogram(position = "fill") +
  # ggplot2::geom_freqpoly(ggplot2::aes(y = ..prop..)) +
  # ggplot2::scale_x_date() +
  # ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  ggplot2::scale_fill_viridis_d(direction = -1) +
  ggplot2::scale_colour_viridis_d(direction = -1) +
  ggplot2::labs(x = "Date", 
                y = NULL, 
                fill = "Selected\nsentiments",
                colour = "Selected\nsentiments") +
  ggplot2::theme(text = ggplot2::element_text(size = 16))
```




```{r}

filter_date_start <- "2018-01-02"
filter_date_end <- "2020-12-02"

filter_TeamN <- c("CAMHS Crisis", "The Orion Unit")
filter_Directorate2 <- c("Adult mental health")
filter_Division2 <- c("Local partnerships- MH")

df_filtered <- tidy_trust_data %>% 
  filter(between(x = date, 
                 left = as.Date(filter_date_start), 
                 right = as.Date(filter_date_end)))# %>% 
  # filter(TeamN %in% c(filter_TeamN)) %>% 
  # filter(Directorate2 %in% c(filter_Directorate2)) %>% 
  # filter(Division2 %in% c(filter_Division2))
```


```{r}

library(patchwork)
df_filtered %>% 
  group_by(super_category, comment_type) %>% 
  summarise(n = n(),
            crit_mean = mean(crit, na.rm = T),
            crit_sd = sd(crit, na.rm = T))

select_category <- c("Access to Services", "Care/ Treatment", "Communication", "Staff/ Staff Attitude")

plot1 <- tidy_trust_data %>% 
  drop_na(crit) %>% 
  filter(super_category %in% {{select_category}}) %>% 
  select(date, crit, super_category, comment_type) %>% 
  ggplot(aes(x = date, fill = factor(crit))) +
  geom_histogram(position = "stack") +
  # geom_density(position = "fill", ) +
    facet_grid(super_category ~ factor(comment_type, 
                                     levels = c("best", "improve"),
                                     labels = c("What was good?", "What could we do better?"))) +
  scale_fill_viridis_d() +
  labs(x = "Date", 
       y = "Number of responses", 
       fill = "Criticality")

# ?geom_histogram
plot1

plot2 <- tidy_trust_data %>% 
  drop_na(crit) %>% 
  filter(super_category %in% {{select_category}}) %>% 
  select(date, crit, super_category, comment_type) %>% 
  ggplot(aes(x = date, fill = factor(crit))) +
  geom_histogram(position = "fill") +
  ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  facet_grid(super_category ~ factor(comment_type, 
                                     levels = c("best", "improve"),
                                     labels = c("What was good?", "What could we do better?"))) +
  scale_fill_viridis_d() +
  labs(x = "Date", 
       y = "Percentage of responses", 
       fill = "Criticality")

plot2


plot1 + plot2

plotly::ggplotly(plot)

# what are meaningful time periods of the year in case I need to categorise
# what does 1 to 3 mean again 

```

